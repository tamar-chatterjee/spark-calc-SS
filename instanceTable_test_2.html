<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AWS EC2 Instance Pricing Comparison</title>
    <!-- Include Montserrat font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <link href="https://unpkg.com/open-props" rel="stylesheet">
    <style>
        html {
            --scrollbar-color: var(--gray-7);
            scrollbar-color: var(--scrollbar-color) transparent;
            font-family: 'Montserrat', sans-serif;
            color: var(--gray-3);
            background: var(--gray-9);
            font-size: 15px; /* Reduced font size by approximately 1pt */
        }
        code { font-family: var(--font-mono); }
        a, a:visited { color: var(--indigo-3); }
        input, select {
            background: var(--gray-8);
            border-radius: var(--radius-2);
            border: var(--border-size-1) solid var(--gray-6);
            color: #fff;
            padding: 5px;
            outline: none;
            font-family: 'Montserrat', sans-serif;
            box-sizing: border-box;
            height: 31px;
            vertical-align: top;
            margin-right: 10px;
            font-size: 12px; /* Reduced font size */
        }
        .tabulator-row .tabulator-cell { padding: 8px 4px; }
        .tabulator-col { padding: 4px; }
        #filterBox { margin-bottom: 20px; }
        /* Updated styles for the header */
        #header {
            text-align: center;
            margin-bottom: 20px;
        }
        #header img {
            max-height: 50px;
            margin-bottom: 10px;
        }
        #header h1 {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 24px; /* Adjust heading font size if desired */
        }
        /* Adjust the font size for Tabulator table headers */
        .tabulator .tabulator-header .tabulator-col {
            font-size: 15px; /* Reduced font size */
        }
        /* Adjust the font size for Tabulator table cells */
        .tabulator .tabulator-table .tabulator-cell {
            font-size: 12px; /* Reduced font size */
        }
    </style>
</head>
<body>
    <div id="header">
        <img src="https://images.squarespace-cdn.com/content/v1/603b90546b16fc4c1c73749b/df30d10b-6f49-419e-a4b4-c08b7eaca16b/Spark_Logo_full_white.png?format=2500w" alt="Logo">
        <h1>Instance Pricing Table</h1>
    </div>

    <p id="filterBox">
        <input type="text" id="search" placeholder="Find Instance">
        <select id="selectInstanceType">
            <option value="">All Instances</option>
            <option value="CPU">CPUs</option>
            <option value="GPU">GPUs</option>
        </select>
        <select id="selectOs">
            <option value="">Any OS</option>
            <option value="Linux">Linux</option>
            <option value="Windows" selected>Windows</option>
        </select>
        <select id="selectRegion"></select>
        <input type="number" id="maxPrice" placeholder="Maximum Price/month">
        <input type="number" id="minMem" placeholder="Minimum Memory (GB)">
        <input type="number" id="minCpu" placeholder="Minimum vCPU">
    </p>

    <div id="example-table"></div>

    <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>
    <script>
        const corsProxy = 'https://corsproxy.io/?';

        // Fill regions dropdown with specified locations only
        loadRegionsList();

        // Bind "input" event for all filters
        document.querySelectorAll("#filterBox *").forEach(inputEl => inputEl.addEventListener("input", updateFilter));

        // Load default region data on startup
        loadRegionData("US East (N. Virginia)");

        async function loadRegionData(regionName) {
            // URLs for fetching Linux and Windows pricing data
            const linUrl = `https://b0.p.awsstatic.com/pricing/2.0/meteredUnitMaps/ec2/USD/current/ec2-ondemand-without-sec-sel/${encodeURIComponent(regionName)}/Linux/index.json`;
            const winUrl = `https://b0.p.awsstatic.com/pricing/2.0/meteredUnitMaps/ec2/USD/current/ec2-ondemand-without-sec-sel/${encodeURIComponent(regionName)}/Windows/index.json`;

            try {
                // Fetch Linux data
                let response = await fetch(corsProxy + encodeURIComponent(linUrl));
                let data = await response.json();
                let regions = data.regions;
                let instances = regions[Object.keys(regions)[0]];
                let instancesArray = Object.values(instances);

                // Fetch Windows data
                response = await fetch(corsProxy + encodeURIComponent(winUrl));
                data = await response.json();
                regions = data.regions;
                instances = regions[Object.keys(regions)[0]];
                instancesArray = instancesArray.concat(Object.values(instances));

                // Process and precompute data
                instancesArray.forEach(i => {
                    i.price = i.price * 1.3; // Add 30% markup to price
                    i.priceMonthly = i.price * 730; // Monthly price with markup
                    i.memoryAsNumber = parseFloat(i.Memory); // Convert Memory to number

                    // Determine if the instance is GPU-based
                    const instanceType = i["Instance Type"].toLowerCase();
                    if (instanceType.startsWith("p") || instanceType.startsWith("g") || instanceType.startsWith("f")) {
                        i.hasGPU = true;
                        i.instanceCategory = "GPU";
                    } else {
                        i.hasGPU = false;
                        i.instanceCategory = "CPU";
                    }
                });

                // Initialize Tabulator table
                if (!window._table) {
                    window._table = new Tabulator("#example-table", {
                        height: "1000px", // Increased height to display more entries
                        data: instancesArray,
                        layout: "fitColumns",
                        columns: [
                            { title: "Name", field: "Instance Type", sorter: "string", width: 150 },
                            { title: "Type", field: "instanceCategory", sorter: "string", width: 80 },
                            { title: "Price ($/hr)", field: "price", sorter: "number", formatter: "money", formatterParams: { precision: 4 } },
                            { title: "Monthly Price", field: "priceMonthly", sorter: "number", formatter: "money", formatterParams: { precision: 2 } },
                            { title: "vCPU", field: "vCPU", sorter: "number", width: 80 },
                            { title: "Memory (GB)", field: "Memory", sorter: "number", width: 100 },
                            { title: "Operating System", field: "Operating System", sorter: "string", width: 120 },
                            { title: "Network Performance", field: "Network Performance", sorter: "string" }
                        ],
                        initialSort: [
                            { column: "price", dir: "asc" }
                        ],
                        placeholder: "No Data Available",
                    });
                } else {
                    window._table.setData(instancesArray);
                    // Apply initial sort when data is replaced
                    window._table.setSort("price", "asc");
                }

                // Apply filters after data is loaded
                updateFilter();

            } catch (error) {
                console.error("Error loading data:", error);
                alert("Failed to load data for the selected region. Please try a different region.");
            }
        }

        async function loadRegionsList() {
            const regionUrl = "https://b0.p.awsstatic.com/pricing/2.0/meteredUnitMaps/ec2/USD/current/ec2-ondemand-without-sec-sel/metadata.json";
            try {
                let response = await fetch(corsProxy + encodeURIComponent(regionUrl));
                let data = await response.json();
                let regions = data.regionAttributes.Location;

                // Only include specific regions
                const allowedRegions = [
                    "US East (N. Virginia)",
                    "US East (Ohio)",
                    "US West (N. California)",
                    "US West (Oregon)",
                    "US West (Portland)"
                ];
                regions = regions.filter(r => allowedRegions.includes(r));

                var select = document.getElementById("selectRegion");

                // Clear existing options
                select.innerHTML = '';

                regions.forEach(r => {
                    var el = document.createElement("option");
                    el.textContent = r;
                    el.value = r;
                    select.appendChild(el);
                });

                select.value = "US East (N. Virginia)"; // Preselect the default region
            } catch (error) {
                console.error("Error loading regions:", error);
            }
        }

        function updateFilter(event) {
            if (event && event.target.id === "selectRegion") {
                loadRegionData(event.target.value);
                return;
            }

            var minMem = parseFloat(document.getElementById("minMem").value) || 0;
            var minCpu = parseInt(document.getElementById("minCpu").value) || 0;
            var os = document.getElementById("selectOs").value;
            var instanceTypeFilter = document.getElementById("selectInstanceType").value;
            var search = document.getElementById("search").value;
            var maxPrice = parseFloat(document.getElementById("maxPrice").value) || Infinity;

            var filters = [];

            if (minCpu) filters.push({ field: "vCPU", type: ">=", value: minCpu });
            if (minMem) filters.push({ field: "memoryAsNumber", type: ">=", value: minMem });
            if (os) filters.push({ field: "Operating System", type: "=", value: os });
            if (search) filters.push({ field: "Instance Type", type: "like", value: search });
            if (maxPrice !== Infinity) filters.push({ field: "priceMonthly", type: "<=", value: maxPrice });

            // Filter based on instance type (CPU/GPU)
            if (instanceTypeFilter === "CPU") {
                filters.push({ field: "hasGPU", type: "=", value: false });
            } else if (instanceTypeFilter === "GPU") {
                filters.push({ field: "hasGPU", type: "=", value: true });
            }

            window._table.setFilter(filters);
        }
    </script>
</body>
</html>
