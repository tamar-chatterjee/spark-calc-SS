<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AWS EC2 Instance Pricing Comparison</title>
    <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <link href="https://unpkg.com/open-props" rel="stylesheet">
    <style>
        html {
            --scrollbar-color: var(--gray-7);
            scrollbar-color: var(--scrollbar-color) transparent;
            font-family: var(--font-sans);
            color: var(--gray-3);
            background: var(--gray-9);
            font-size: var(--font-size-1);
        }
        code { font-family: var(--font-mono); }
        a, a:visited { color: var(--indigo-3); }
        input, select {
            background: var(--gray-8);
            border-radius: var(--radius-2);
            border: var(--border-size-1) solid var(--gray-6);
            color: #fff;
            padding: 5px;
            outline: none;
            font-family: var(--font-sans);
            box-sizing: border-box;
            height: 31px;
            vertical-align: top;
        }
        .tabulator-row .tabulator-cell { padding: 8px 4px; }
        .tabulator-col { padding: 4px; }
        #filterBox { margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>AWS EC2 Instance Pricing Comparison</h1>

    <p>The data is pulled directly from AWS docs, the same JSON endpoint their <a href="https://aws.amazon.com/ec2/pricing/on-demand/" rel="nofollow">pricing page</a> pulls it from, so the data is always up to date. The pricing is for "on-demand" and "reserved 1yr convertible" instances.</p>

    <p id="filterBox">
        <input type="number" id="minMem" placeholder="Min Memory (GB)">
        <input type="number" id="minCpu" placeholder="Min vCPU">
        <input type="number" id="maxPrice" placeholder="Max Price/mo">
        <select id="selectOs">
            <option value="">Any OS</option>
            <option value="Linux">Linux</option>
            <option value="Windows" selected>Windows</option>
        </select>
        <select id="selectRegion"></select>
        <input type="text" id="search" placeholder="Find instance name" style="float:right;">
    </p>

    <div id="example-table"></div>

    <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>
    <script>
        const corsProxy = 'https://corsproxy.io/?';

        // Fill regions dropdown with specified locations only
        loadRegionsList();

        // Bind "input" event for all filters
        document.querySelectorAll("#filterBox *").forEach(inputEl => inputEl.addEventListener("input", updateFilter));

        // Load default region data on startup
        loadRegionData("US East (N. Virginia)");

        async function loadRegionData(regionName) {
            // URLs for fetching Linux and Windows pricing data
            const linUrl = `https://b0.p.awsstatic.com/pricing/2.0/meteredUnitMaps/ec2/USD/current/ec2-ondemand-without-sec-sel/${encodeURIComponent(regionName)}/Linux/index.json`;
            const winUrl = `https://b0.p.awsstatic.com/pricing/2.0/meteredUnitMaps/ec2/USD/current/ec2-ondemand-without-sec-sel/${encodeURIComponent(regionName)}/Windows/index.json`;

            try {
                // Fetch Linux data
                let response = await fetch(corsProxy + encodeURIComponent(linUrl));
                let data = await response.json();
                let regions = data.regions;
                let instances = regions[Object.keys(regions)[0]];
                let instancesArray = Object.values(instances);

                // Fetch Windows data
                response = await fetch(corsProxy + encodeURIComponent(winUrl));
                data = await response.json();
                regions = data.regions;
                instances = regions[Object.keys(regions)[0]];
                instancesArray = instancesArray.concat(Object.values(instances));

                // Process and precompute data
                instancesArray.forEach(i => {
                    i.priceMonthly = i.price * 730; // Monthly price (assuming 730 hours/month)
                    i.reservedPriceMonthly = i.priceMonthly * 0.73; // Reserved price (27% savings)
                    i.memoryAsNumber = parseFloat(i.Memory); // Convert Memory to number
                });

                // Initialize Tabulator table
                if (!window._table) {
                    window._table = new Tabulator("#example-table", {
                        height: "600px",
                        data: instancesArray,
                        layout: "fitColumns",
                        columns: [
                            { title: "Instance Type", field: "Instance Type", sorter: "string", width: 150 },
                            { title: "Price ($/hr)", field: "price", sorter: "number", formatter: "money", formatterParams: { precision: 4 } },
                            { title: "Monthly Price", field: "priceMonthly", sorter: "number", formatter: "money", formatterParams: { precision: 2 } },
                            { title: "Reserved 1yr Monthly", field: "reservedPriceMonthly", sorter: "number", formatter: "money", formatterParams: { precision: 2 } },
                            { title: "vCPU", field: "vCPU", sorter: "number", width: 80 },
                            { title: "Memory (GB)", field: "Memory", sorter: "number", width: 100 },
                            { title: "Operating System", field: "Operating System", sorter: "string", width: 120 },
                            { title: "Storage", field: "Storage", sorter: "string" },
                            { title: "Network Performance", field: "Network Performance", sorter: "string" }
                        ],
                        placeholder: "No Data Available",
                    });
                } else {
                    window._table.replaceData(instancesArray);
                }

                // Apply filters after data is loaded
                updateFilter();

            } catch (error) {
                console.error("Error loading data:", error);
            }
        }

        async function loadRegionsList() {
            const regionUrl = "https://b0.p.awsstatic.com/pricing/2.0/meteredUnitMaps/ec2/USD/current/ec2-ondemand-without-sec-sel/metadata.json";
            try {
                let response = await fetch(corsProxy + encodeURIComponent(regionUrl));
                let data = await response.json();
                let regions = data.regionAttributes.Location;

                // Only include specific regions
                const allowedRegions = ["US East (N. Virginia)", "US West (N. California)", "US West (Oregon)"];
                regions = regions.filter(r => allowedRegions.includes(r));

                var select = document.getElementById("selectRegion");
                regions.forEach(r => {
                    var el = document.createElement("option");
                    el.textContent = r;
                    el.value = r;
                    select.appendChild(el);
                });
                select.value = "US East (N. Virginia)"; // Preselect the default region
            } catch (error) {
                console.error("Error loading regions:", error);
            }
        }

        function updateFilter(event) {
            if (event && event.target.id === "selectRegion") {
                loadRegionData(event.target.value);
                return;
            }

            var minMem = parseFloat(document.getElementById("minMem").value) || 0;
            var minCpu = parseInt(document.getElementById("minCpu").value) || 0;
            var os = document.getElementById("selectOs").value;
            var search = document.getElementById("search").value;
            var maxPrice = parseFloat(document.getElementById("maxPrice").value) || Infinity;

            var filters = [];

            if (minCpu) filters.push({ field: "vCPU", type: ">=", value: minCpu });
            if (minMem) filters.push({ field: "memoryAsNumber", type: ">=", value: minMem });
            if (os) filters.push({ field: "Operating System", type: "=", value: os });
            if (search) filters.push({ field: "Instance Type", type: "like", value: search });
            if (maxPrice !== Infinity) filters.push({ field: "priceMonthly", type: "<=", value: maxPrice });

            window._table.setFilter(filters);
        }
    </script>
</body>
</html>
